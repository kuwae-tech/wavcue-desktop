<!DOCTYPE html>
<html lang="ja"><head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><title>WavCue</title><style>
/* CODE ORGANIZATION
   - Root tokens
   - Base
   - Layout
   - Components
   - Dialogs
   - Tables/Lists
   - Utilities
*/

/* Icon (SVG) */
.btnIcon{
  width: 14px;
  height: 14px;
  display: inline-block;
  vertical-align: -2px;
  margin-right: 8px;
  opacity: .95;
}
.btnIcon use{ pointer-events:none; }

  :root{
    --bg:#0b0c0f;
    --panel:#121417;
    --panel2:#171a1f;
    --line:#242a33;
    --text:#e9ecf1;
    --muted:#aab2bd;
    --good:#7ee7a2;
    --accent:#ffd24a;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow: 0 18px 48px rgba(0,0,0,.45);
    --r:16px;
    --app-pad: 10px;
    --app-gap: 10px;
    --brand-logo-h: 44px;
    --bottom-line-h: 240px;
    --bottom-line-h: 252px;
    --fileList-min-h: var(--bottom-line-h);
    --wave-min-h: 210px;
    --wave-min-h: 196px;
    --stereo-box-h: var(--bottom-line-h);
    --titlebar-drag-h: 34px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% 10%, #15264a 0%, var(--bg) 55%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;-webkit-user-select:none;user-select:none}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% 10%, #15264a 0%, var(--bg) 55%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;-webkit-user-select:none;user-select:none;min-width:1240px}
  body{padding-top: var(--titlebar-drag-h)}
  .app{height:100%;display:flex;flex-direction:column;gap:var(--app-gap);padding:var(--app-pad)}
  .appHeader{
    display:flex;
    align-items:center;
    gap:12px;
    -webkit-app-region: drag;
    flex: 0 0 auto;
    overflow: visible;
    padding-bottom: 2px;
    flex-wrap: nowrap;
    white-space: nowrap;
  }
  .hdrLeft{
    flex:0 0 auto;
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
    flex-wrap:nowrap;
    min-width:max-content;
  }
  .hdrMid{
    flex: 1 1 auto;
    min-width: 0;
@@ -288,91 +288,91 @@
  #wave{
    width:100% !important;height:100% !important;
    display:block;
    touch-action:none;
    cursor:crosshair;
  }
  #cueCanvas{
    position:absolute;left:0;top:0;
    width:100% !important;height:100% !important;
    display:block;
    pointer-events:none;
  }
  .waveHud{
    position:absolute;left:10px;top:10px;
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    pointer-events:none;
  }
  .hudChip{
    pointer-events:none;
    font-size:11px;color:rgba(229,231,235,.84);
    background:rgba(0,0,0,.35);border:1px solid rgba(148,163,184,.22);
    padding:6px 8px;border-radius:999px;
    backdrop-filter: blur(6px);
  }
  .analyzers{
    flex:0 0 180px;
    height:180px;
    min-height:180px;
    max-height:180px;
    flex:0 0 var(--bottomH);
    height:var(--bottomH);
    min-height:var(--bottomH);
    max-height:var(--bottomH);
    display:flex;
    gap:10px;
    align-items:stretch;
    min-height:0;
    min-width:0;
  }
  .meterBlock,
  .imagerBlock,
  .scopeBlock{
    display:flex;
    align-items:stretch;
    justify-content:center;
  }
  .meterBlock{
    flex:0 0 120px;
    width:120px;
    min-width:120px;
    max-width:120px;
  }
  .imagerBlock,
  .scopeBlock{
    flex:0 0 180px;
    width:180px;
    height:180px;
    height:var(--bottomH);
    min-width:180px;
    max-width:180px;
    border-radius:12px;
    overflow:hidden;
    display:flex;
    align-items:stretch;
    justify-content:stretch;
  }
  .meterBox,
  .scopeBox{
    border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.12);
  }
  .meterBox{height:180px}
  .meterBox{height:var(--bottomH)}
  .scopeBox{
    flex:1;
    min-width:0;
    min-height:0;
    height:100%;
    width:100%;
    display:flex;
  }
  #meterCanvas{width:100% !important;height:100% !important;display:block}
  #imagerCanvas{width:100% !important;height:100% !important;display:block}
  .right{display:flex;flex-direction:column;min-height:0}
  .cueSide{
    width: 340px;
    min-width: 340px;
    max-width: 340px;
    flex: 0 0 340px;
    overflow: auto;
    border-left: 1px solid rgba(255,255,255,.08);
  }
  .right .sectionHead{border-bottom:1px solid var(--line)}
  .sidePad{padding:10px;display:flex;flex-direction:column;gap:10px;min-height:0}
  .card{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rowBetween{display:flex;gap:8px;align-items:center;justify-content:space-between}
  #btnAddPair{
@@ -923,51 +923,51 @@
    display:grid;
    gap:4px;
  }
  .confirmDialog .confirmActions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:8px;
  }
  @media (max-width: 640px){
    .settingsDialog .rulesGrid{
      grid-template-columns: 1fr;
    }
  }
  textarea{
    width:100%;height:220px;border-radius:14px;border:1px solid var(--line);
    background:rgba(0,0,0,.16);color:var(--text);
    padding:10px;font-size:12px;outline:none;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }
  .logBox{height:240px;overflow:auto;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.16);padding:10px}
  .logLine{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:11px;color:rgba(229,231,235,.80);white-space:pre-wrap;margin:0 0 6px 0}
  
  .waveBox{flex:1;min-height:0}
  .transport{
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    display:flex;align-items:center;gap:8px;flex-wrap:nowrap;white-space:nowrap;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:14px;
    background:rgba(0,0,0,.10);
  }
  .tbtn{
    appearance:none;border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    font-size:12px;
    line-height:1;
    display:inline-flex;gap:8px;align-items:center;
  }
  .tbtn:hover{background:rgba(255,255,255,.07)}
  .tbtn:disabled{opacity:.45;cursor:not-allowed}
  .tsep{width:1px;height:28px;background:rgba(148,163,184,.22);margin:0 4px}
  .thint{margin-left:auto;color:rgba(229,231,235,.55);font-size:11px;white-space:nowrap}

  

/* CMCD */
.cmcdBox{
@@ -2673,76 +2673,89 @@ body,
  -webkit-app-region: drag;
}
button, a, input, textarea, select, label,
.btn, .iconBtn, .tabBtn, .pill, .chip,
.dialog, dialog, .modal, .modalContent, .modalBody, .modalFooter{
  -webkit-app-region: no-drag !important;
}
dialog,
dialog *{
  -webkit-app-region: no-drag !important;
}
body, #appRoot, .appRoot, .mainLayout{
  -webkit-app-region: no-drag;
}
.appRoot,
.mainLeft{
  overflow: hidden !important;
}

.proFileDock{ flex:1 1 auto; min-width:0; min-height:0; height:100%; display:flex; flex-direction:column; position:relative; overflow:hidden; }
#proFileDock{ flex: 1 1 auto; min-width:0; min-height:0; display:flex; flex-direction:column; overflow:hidden; }
#proFileDock .proFileListWrap{ flex:1 1 auto; min-height:0; display:flex; overflow:hidden; }
#proFileDock .proFileList{ flex:1 1 auto; min-height:0; overflow:auto; padding:6px 8px; }
.proFileDockTop{
  flex:0 0 auto;
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:6px 8px 8px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:6px;
  padding:4px 8px 6px;
  border-bottom:1px solid rgba(255,255,255,0.08);
  flex-wrap:nowrap;
  overflow-x:auto;
  overflow-y:visible;
  min-width:0;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
.proFileDockLeft{ display:flex; gap:6px; flex-wrap:nowrap; flex:1 1 auto; min-width:0; overflow:hidden; }
.proFileDockRight{ display:flex; gap:6px; align-items:center; flex-wrap:nowrap; justify-content:flex-end; min-width:0; }
.proFileDockTop::-webkit-scrollbar{ display:none; }
.proDockSpacer{ flex:1 1 auto; min-width:12px; }
.proOnlyWrap{
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  flex: 0 1 auto;
  flex: 0 0 auto;
  flex-shrink: 0;
  min-width: 0;
}
.proOnlyWrap .btn{
  flex: 0 1 auto;
  flex-shrink: 0;
  min-width: 0;
  max-width: 100%;
  white-space: nowrap;
  word-break: keep-all;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
  padding: 9px 8px;
}
.proOnlyWrap select{
  flex-shrink: 0;
}
.proOnlyWrap .btnLabel{
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  word-break: keep-all;
  display: block;
}
.proOnlyWrap .proBadge{
  display: none;
  font-size: 10px;
  line-height: 1;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(251,191,36,.65);
  color: rgba(251,191,36,.95);
  background: rgba(15,23,42,.6);
  flex: 0 0 auto;
  white-space: nowrap;
}
.proOnlyWrap .proTooltip{
  position: absolute;
  left: 50%;
  bottom: calc(100% + 6px);
  transform: translate(-50%, -4px);
@@ -2756,120 +2769,120 @@ body, #appRoot, .appRoot, .mainLayout{
  border: 1px solid rgba(148,163,184,.2);
  pointer-events: none;
  transition: opacity .12s ease, transform .12s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,.35);
  z-index: 6;
}
  .proOnlyWrap.proOnlyDisabled .btn{
    opacity: .45;
    cursor: not-allowed;
    pointer-events: none;
  }
  .proOnlyWrap.proOnlyDisabled .proJobMini{
    opacity: .45;
    cursor: not-allowed;
    pointer-events: none;
  }
  .proOnlyWrap.proOnlyDisabled .proBadge{
    display: inline-flex;
  }
.proOnlyWrap.proOnlyDisabled:hover .proTooltip{
  opacity: 1;
  transform: translate(-50%, -6px);
}
.proInput{ height:28px; padding:0 8px; width:180px; }
.proSelect{ height:28px; }
.proFilterWrap{ min-width: 0; flex: 1 1 auto; }
.proFilterWrap{ min-width: 0; flex: 0 0 auto; }
#proFilterStatus{
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  height: 32px;
  padding: 0 34px 0 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(240,242,246,.95);
  outline: none;
  min-width: 0;
  max-width: 100%;
}
#proFilterStatus:focus{
  border-color: rgba(103,167,255,.55);
  box-shadow: 0 0 0 3px rgba(103,167,255,.18);
}
.proFilterWrap{
  position: relative;
  display: inline-block;
}
.proFilterWrap::after{
  content: "▾";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-52%);
  pointer-events: none;
  color: rgba(240,242,246,.65);
  font-size: 12px;
}
.proBottomRow,
.bottomRow{
  flex: 0 0 180px;
  height: 180px;
  min-height: 180px;
  max-height: 180px;
  flex: 0 0 var(--bottomH);
  height: var(--bottomH);
  min-height: var(--bottomH);
  max-height: var(--bottomH);
  display: flex;
  align-items: stretch;
  gap: 12px;
  padding: 10px;
  overflow: hidden;
  min-width: 0;
}
.proBottomRow .proMeterBox{
  width: 120px;
  min-width: 120px;
  max-width: 120px;
  flex: 0 0 120px;
  border-radius: 12px;
  overflow: hidden;
}
.meterBox{
  width: 120px;
  min-width: 120px;
  max-width: 120px;
  flex: 0 0 120px;
  border-radius: 12px;
  overflow: hidden;
}
.proBottomRow .proImagerBox,
.imagerBox{
  width: 180px;
  min-width: 180px;
  max-width: 180px;
  height: 180px;
  min-height: 180px;
  max-height: 180px;
  height: var(--bottomH);
  min-height: var(--bottomH);
  max-height: var(--bottomH);
  flex: 0 0 180px;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  align-items: stretch;
  justify-content: stretch;
}
.proBottomRow .proImagerBox canvas,
.imagerBox canvas{
  width: 100% !important;
  height: 100% !important;
  display: block;
}
.proBottomRow .proFileListBox,
.fileListBox{
  flex: 1 1 auto;
  min-width: 0;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.proFileListWrap{
  flex:1 1 auto; min-height:0; display:flex; flex-direction:column;
  border:1px solid var(--line);
@@ -3188,51 +3201,51 @@ body, #appRoot, .appRoot, .mainLayout{
}
.ngDetailKey{ font-size:12px; color:var(--muted); letter-spacing:.02em; }
.ngDetailVal{ font-size:13px; color:#e2e8f0; }
.ngDetailGrid{
  margin-top:8px;
  display:grid;
  grid-template-columns:120px 1fr;
  gap:6px 10px;
  font-size:12px;
}
.ngDetailGrid .label{ color:var(--muted); }
.ngDetailEmpty{
  padding:10px 12px;
  border-radius:12px;
  border:1px dashed rgba(255,255,255,0.16);
  color:var(--muted);
  font-size:12px;
}


/* ===== Layout lock (Pro multi-file) - resize safe (FIX) ===== */

/* 右サイド幅・下段高さをここに統一 */
:root{
  --cueW: 340px;
  --bottomH: 190px;     /* 下段(メーター/イメージャ/ファイルリスト)固定高さ */
  --bottomH: var(--bottom-line-h);     /* 下段(メーター/イメージャ/ファイルリスト)固定高さ */
  --meterW: 140px;
  --imagerS: 190px;
  --gap: 12px;
}

/* main は “flexで伸びる” を最優先（height固定しない） */
.main{
  display:grid !important;
  grid-template-columns: minmax(0,1fr) var(--cueW) !important;
  gap: var(--gap) !important;

  flex: 1 1 auto !important;
  min-height: 0 !important;
  height: auto !important;        /* ★重要：calc(vh...)で固定しない */
}

/* 左カラム */
.left{
  min-width: 0 !important;
  min-height: 0 !important;
  overflow: hidden !important;

  display:flex !important;
  flex-direction: column !important;
}
@@ -3275,51 +3288,51 @@ body, #appRoot, .appRoot, .mainLayout{
#analyzersRow{
  flex: 0 0 var(--bottomH) !important;
  height: var(--bottomH) !important;
  min-height: var(--bottomH) !important;
  max-height: var(--bottomH) !important;

  display:flex !important;
  gap: var(--gap) !important;
  align-items: stretch !important;
  overflow: hidden !important;
  position: relative !important;
}

/* メーター・イメージャの枠 */
.meterBox, .meterBlock{
  width: var(--meterW) !important;
  min-width: var(--meterW) !important;
  height: 100% !important;
  overflow: hidden !important;
  border-radius: 12px !important;
}
.imagerBox, .imagerBlock{
  width: var(--imagerS) !important;
  min-width: var(--imagerS) !important;
  height: 100% !important;
  aspect-ratio: 1 / 1 !important;
  aspect-ratio: auto !important;
  overflow: hidden !important;
  border-radius: 12px !important;
}

/* ファイルリストは残り横幅を全て、縦は枠内スクロール */
#proFileDock, .proFileDock{
  flex: 1 1 auto !important;
  min-width: 0 !important;
  height: 100% !important;
  overflow: hidden !important;
  border-radius: 12px !important;
  display:flex !important;
  flex-direction: column !important;
}
#proFileListWrap{
  flex: 1 1 auto !important;
  min-height: 0 !important;
  overflow: auto !important;
}

/* canvasは枠に追従 */
#meterCanvas, #imagerCanvas{
  width: 100% !important;
  height: 100% !important;
  display:block !important;
@@ -3515,51 +3528,51 @@ body, #appRoot, .appRoot, .mainLayout{
  /* メーター：固定幅 */
  .bottomRow .meterBox, .bottomRow .proMeterBox {
    width: 140px !important;
    min-width: 140px !important;
    height: 100% !important;
    border-radius: 12px !important;
    overflow: hidden !important;
  }

  /* イメージャ：正方形固定（高さに追従） */
  .bottomRow .imagerBox, .bottomRow .proImagerBox {
    width: 210px !important;            /* bottomRowの高さと揃えると正方形に見える */
    min-width: 210px !important;
    height: 100% !important;
    border-radius: 12px !important;
    overflow: hidden !important;
  }

  /* ファイルリスト：残り全部。幅0禁止。左下見切れ対策で内側padding */
  .bottomRow .fileListBox, .bottomRow .proFileListBox {
    flex: 1 1 auto !important;
    min-width: 0 !important;
    height: 100% !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    padding: 8px 8px 14px 8px;   /* 左下見切れ対策 */
    padding: 4px 8px 14px 8px;   /* 左下見切れ対策 */
    box-sizing: border-box !important;
  }

  /* これが幅0になっていた本丸：必ず伸びるように固定 */
  #proFileDock, .proFileDock {
    flex: 1 1 auto !important;
    min-width: 0 !important;
    width: auto !important;
    height: 100% !important;
    overflow: auto !important;
    position: relative !important;
  }

  /* 波形ビュー縦幅を現状の約80%へ */
  .waveWrap{
    flex: 0 0 auto !important;
    min-height: 0 !important;
  }

  /* 左パネルがflex縦なら、波形部分を少し抑える */
  .panel.left, .left.panel{
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
  }
@@ -3590,51 +3603,51 @@ body, #appRoot, .appRoot, .mainLayout{
  .cueTopControls button,
  .cueTopControls .btn{
    white-space: nowrap;
  }
  .cueTopControls input{
    flex: 1;
    min-width: 0;
  }
  /* ===== /Bottom analyzers layout hardening ===== */

  /* ===== FIX: bottom row (meter/imager/file list) collapsing to width:0 ===== */
  /* analyzersRow は「下段」を縦方向のスタックとして固定（row化すると proBottomRow が幅180扱いで潰れる） */
  #analyzersRow,
  .workBottom.analyzers{
    display: flex !important;
    flex-direction: column !important;
    width: 100% !important;
    min-width: 0 !important;
    min-height: 0 !important;
  }

  /* proBottomRow は “高さ180pxの段” であり、幅を100%保証する */
  .proBottomRow,
  .bottomRow{
    width: 100% !important;
    flex: 0 0 180px !important;   /* column時は高さとして効く */
    flex: 0 0 var(--bottomH) !important;   /* column時は高さとして効く */
    box-sizing: border-box !important;
    min-width: 0 !important;
  }

  /* 中身（ファイルリスト側）が 0 幅にならないための保険 */
  .proBottomRow .proFileListBox,
  .fileListBox,
  #proFileDock,
  .proFileDock{
    flex: 1 1 0% !important;
    min-width: 0 !important;
  }

  /* ===== Stability patch: bottom row width + cue pair layout ===== */
  .bottomRow,
  .proBottomRow,
  #analyzersRow,
  .analyzers{
    width: 100% !important;
    min-width: 0 !important;
    flex-basis: auto !important;
  }
  .fileListBox,
  .proFileListBox,
  #proFileDock,
@@ -3756,50 +3769,426 @@ body, #appRoot, .appRoot, .mainLayout{
  }
  .meterBox,
  .proMeterBox{
    padding-bottom: 10px;
    overflow: visible;
  }
  .imagerBox,
  .proImagerBox{
    padding-bottom: 12px;
    overflow: visible;
    box-sizing: border-box;
  }
  .imagerBox canvas,
  .proImagerBox canvas{
    height: 100% !important;
    width: 100% !important;
    display: block;
  }

  .fileListBox,
  .proFileListBox{
    min-height: var(--bottom-line-h);
    height: var(--bottom-line-h);
    overflow: hidden;
  }
  /* ==== FINAL OVERRIDES: PRO-only visual parity (must win) ==== */
  /* 履歴ボタンを他.btnと同じ“PRO無効ボタン”の見た目に揃える（サイズだけ調整） */
  #proJobMini.btn.proJobMini{
    height:32px !important;
    padding: 9px 10px !important;
    border-radius:12px !important;
    display:inline-flex !important;
    align-items:center !important;
    gap:8px !important;
  }
  /* ============================================================
     FINAL OVERRIDES (Bottom layout truth)
     - Fix meter bottom crop (rounded corners)
     - Align meter/imager/file list bottoms
     - Keep file dock controls sane (no scattered buttons)
     ============================================================ */

  /* ① bottomRow の高さを“1つ”に統一（他の競合は無視） */
  :root{
    --wcBottomH: 240px;      /* 下段高さの真実（他の --bottomH/--bottom-line-h は無視） */
    --wcBottomGap: 12px;
    --wcBottomPad: 14px;
    --wcMeterW: 120px;
    --wcImagerS: 240px;      /* bottomHと合わせると正方形 */
  }

  /* bottomコンテナは必ずこの高さで、子はstretch */
  .workBottom,
  #analyzersRow,
  .analyzersRow,
  .analyzers,
  .bottomRow,
  .proBottomRow{
    height: var(--wcBottomH) !important;
    min-height: var(--wcBottomH) !important;
    max-height: var(--wcBottomH) !important;
    display: flex !important;
    align-items: stretch !important;
    gap: var(--wcBottomGap) !important;
    padding: var(--wcBottomPad) !important;
    box-sizing: border-box !important;
    overflow: hidden !important;  /* はみ出しは許可しない */
    transform: none !important;   /* 変な持ち上げ禁止 */
  }

  /* ② メーター：はみ出しの主因を潰す（box-sizing + padding 제거 + 100%） */
  .meterBox,
  .proMeterBox,
  .meterBlock{
    width: var(--wcMeterW) !important;
    min-width: var(--wcMeterW) !important;
    max-width: var(--wcMeterW) !important;
    flex: 0 0 var(--wcMeterW) !important;
    height: 100% !important;
    min-height: 0 !important;
    padding: 0 !important;          /* ←これが重要（見かけ高さ増加を防ぐ） */
    box-sizing: border-box !important;
    overflow: hidden !important;     /* 親で切られないよう、自分でクリップ */
    border-radius: 12px !important;
    display: flex !important;
    align-items: stretch !important;
  }

  /* canvas は枠に追従 */
  #meterCanvas{
    width: 100% !important;
    height: 100% !important;
    display: block !important;
  }

  /* ③ イメージャ：下端揃え（上に浮く原因を潰す） */
  .imagerBox,
  .proImagerBox,
  .imagerBlock{
    width: var(--wcImagerS) !important;
    min-width: var(--wcImagerS) !important;
    max-width: var(--wcImagerS) !important;
    flex: 0 0 var(--wcImagerS) !important;
    height: 100% !important;
    min-height: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    border-radius: 12px !important;
    display: flex !important;
    align-items: stretch !important;
    justify-content: stretch !important;
    transform: none !important;
    margin: 0 !important;
  }
  #imagerCanvas{
    width: 100% !important;
    height: 100% !important;
    display: block !important;
  }

  /* ④ ファイルリスト：残り幅を全部、縦は100%で下端揃え */
  .fileListBox,
  .proFileListBox,
  #proFileDock,
  .proFileDock{
    flex: 1 1 auto !important;
    min-width: 0 !important;
    height: 100% !important;
    min-height: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    border-radius: 12px !important;
    display: flex !important;
    flex-direction: column !important;
  }

  /* ⑤ “ボタン群＋フィルター” の位置を上げて、見切れ/右詰め過ぎを防ぐ */

  /* フィルター等が “右に寄りすぎて見切れる” のを防ぐ（wrapのmin-width問題を潰す） */
  .proOnlyWrap{
    min-width: 0 !important;
    max-width: 100% !important;
  }
  .proOnlyWrap .btn,
  .proOnlyWrap select{
    min-width: 0 !important;
    max-width: 100% !important;
  }
  .proBtnGroup{
    position: relative !important;
    display:inline-flex !important;
    align-items:center !important;
    gap:6px !important;
    flex:0 0 auto !important;
    white-space:nowrap !important; /* バッジ落ち防止 */
  }
  .proBtnGroup > .btn,
  .proBtnGroup > select{
    flex: 0 0 auto !important;
  }
  .proBtnGroup .proBadge{
    flex:0 0 auto !important;
    white-space:nowrap !important;
  }
  

  /* リスト本体：上の余白を詰め、下端は切れない */
  #proFileListWrap,
  .proFileListWrap{
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: hidden !important;
  }
  .proFileList{
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: auto !important;
    padding: 4px 8px 18px !important;  /* 下側の余白を少し増やす */
  }
  .proFileRow{
    padding: 4px 8px !important;
  }
  #proFileDock .proFileList{
    padding: 4px 8px !important;
  }
  .waveWrap{
    gap: var(--gap) !important;
  }
  .waveBox{
    border-radius:12px !important;
    overflow:hidden !important;
  }
  .transport{
    border-radius:12px !important;
    padding:8px 10px !important;
  }
  /* ===== FINAL: PRO badge is ALWAYS outside (no overlay) ===== */
  .proOnlyWrap,
  .proBtnGroup,
  #proJobMiniWrap,
  #proFilterWrap{
    position: relative !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
    white-space: nowrap !important;
    flex: 0 0 auto !important;
    flex-shrink: 0 !important;
    min-width: 0 !important;
  }
  .proBadge{
    position: static !important;
    top: auto !important;
    right: auto !important;
    transform: none !important;
    margin: 0 !important;
    z-index: auto !important;
    pointer-events: none !important;
    white-space: nowrap !important;
  }
  .proOnlyWrap .btn,
  .proBtnGroup .btn,
  #proJobMiniWrap .btn,
  #proFilterWrap .btn,
  #proFilterWrap select{
    padding-right: 12px !important;
  }
  
  #proFilterWrap{
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 0 !important;
    margin: 0 !important;
    flex: 0 0 auto !important;
    min-width: 0 !important;
    background: none !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
  }
  #proFilterWrap::before,
  #proFilterWrap::after{
    display: none !important;
    content: none !important;
  }
  #proFilterStatus,
  .proFilterSelect{
    appearance: none !important;
    -webkit-appearance: none !important;
    display: inline-flex !important;
    align-items: center !important;
    width: auto !important;
    min-width: 96px !important;
    max-width: 100% !important;
    height: 32px !important;
    line-height: 1.2 !important;
    padding: 9px 28px 9px 10px !important;
    border-radius: 12px !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    background: rgba(255,255,255,0.04) !important;
    color: rgba(255,255,255,0.92) !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    box-sizing: border-box !important;
    position: relative !important;
    z-index: 1 !important;
  }
  /* ===== FINAL: Imager follows UI alignment (no square lock) ===== */
  .imagerBox,
  .proImagerBox,
  .imagerBlock{
    width: auto !important;
    height: 100% !important;
    flex: 1 1 auto !important;
    aspect-ratio: auto !important;
  }
  .imagerBlock{
    height: 100% !important;
    min-height: 0 !important;
  }
  /* FINAL OVERRIDES active selectors:
     - .proFileDockTop/.proFileDockLeft/.proFileDockRight (wrap + no overlap)
     - .imagerBlock/.imagerBox/.proImagerBox (height:100% alignment)
     - :root --wcBottomH (single source of truth) */
  .imagerBox canvas,
  .proImagerBox canvas,
  .imagerBlock canvas{
    width: 100% !important;
    height: 100% !important;
    display: block !important;
  }
  .bottomRow,
  .proBottomRow{
    padding: 10px !important;
    align-items: stretch !important;
  }
  .meterBox,
  .imagerBox,
  .fileListBox{
    padding: 0 !important;
    overflow: hidden !important;
    border-radius: 12px !important;
  }
  /* =========================
     HOTFIX 2026-02-03
     Bottom dock controls:
     - no hover clipping
     - filter looks like buttons
     - no overlap (push each other)
     ========================= */
  

  /* 3つの一括ボタンは横並び維持（ただし全体は押し合いで折返し可） */
  .proBtnGroup{
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
    flex-wrap: nowrap !important;
  }

  /* 下段ドック内：hoverでtranslateしない（overflow:hidden配下で欠けるため） */
  .proFileDockTop .btn:hover,
  .proFileDockTop .btn:focus-visible{
    transform: none !important;
  }
  .proFileDockTop .btn:hover{
    box-shadow: 0 10px 22px rgba(0,0,0,0.35) !important;
  }

  /* 下段ドック内：見切れて「欠け」に見えるツールチップは出さない */
  .proFileDockTop .proTooltip{
    display: none !important;
  }

  /* フィルター旧矢印（class側）を完全無効化（謎領域の温床） */
  .proFilterWrap::after{
    display: none !important;
    content: none !important;
  }

  /* フィルターラッパ：余計な背景/スペースを持たない */
  #proFilterWrap{
    position: relative !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
    padding: 0 !important;
    margin: 0 !important;
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    min-width: 0 !important;
    flex: 0 1 auto !important;
  }

  /* selectを“ボタン”として統一（高さ/角丸/パディング） */
  #proFilterStatus{
    -webkit-appearance: none !important;
    appearance: none !important;
    height: 32px !important;
    line-height: 1.2 !important;
    padding: 9px 28px 9px 10px !important; /* 右に矢印分 */
    border-radius: 12px !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    background: rgba(255,255,255,0.04) !important;
    color: rgba(255,255,255,0.92) !important;
    min-width: 0 !important;  /* 固定minWidthでの力技は禁止 → 0で押し合い */
    max-width: 100% !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    box-sizing: border-box !important;
    position: relative !important;
    z-index: auto !important; /* 変な重なりを防ぐ */
  }

  /* フィルター矢印はid側で描画（重複矢印/謎スペース防止） */
  #proFilterWrap::after{
    content: "▾" !important;
    position: absolute !important;
    right: 10px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    pointer-events: none !important;
    color: rgba(240,242,246,0.65) !important;
    font-size: 12px !important;
  }

  /* フィルターもhoverで欠けない（translate禁止 + shadowのみ） */
  #proFilterStatus:hover{
    transform: none !important;
    box-shadow: 0 10px 22px rgba(0,0,0,0.35) !important;
  }

  /* 履歴ボタンも同じhover挙動（欠けない） */
  #proJobMini:hover{
    transform: none !important;
    box-shadow: 0 10px 22px rgba(0,0,0,0.35) !important;
  }
  /* ===== /UI adjustments ===== */
</style></head><body>
<div id="titlebarDrag"></div>
<!-- ICON SPRITE (no emoji) -->
<svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg">
<symbol id="ico-folder" viewbox="0 0 24 24">
<path d="M3 6a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
</symbol>
<symbol id="ico-puzzle" viewbox="0 0 24 24">
<path d="M8 2a2 2 0 0 0-2 2v1H5a2 2 0 0 0-2 2v2h1a2 2 0 1 1 0 4H3v2a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h2v-1a2 2 0 1 1 4 0v1h2a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2v-2h-1a2 2 0 1 1 0-4h1V7a2 2 0 0 0-2-2h-1V4a2 2 0 0 0-2-2h-2v1a2 2 0 1 1-4 0V2H8z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
</symbol>
<symbol id="ico-file-text" viewbox="0 0 24 24">
<path d="M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7l-5-5z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
<path d="M14 2v5h5" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
<path d="M8 13h8M8 17h8M8 9h3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
</symbol>
<symbol id="ico-check" viewbox="0 0 24 24">
<path d="M20 6 9 17l-5-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"></path>
</symbol>
<symbol id="ico-clipboard-check" viewbox="0 0 24 24">
<path d="M9 2h6a2 2 0 0 1 2 2v2h-2V5H9v1H7V4a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
<path d="M7 6h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
<path d="M9 14l2 2 4-4" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"></path>
</symbol>
<symbol id="ico-download" viewbox="0 0 24 24">
@@ -3842,87 +4231,96 @@ body, #appRoot, .appRoot, .mainLayout{
    <div class="brand">
      <span aria-hidden="true" class="brandMark">
        <img alt="" class="brandLogo" src="./wavcue-logo-set.svg"/>
      </span>
    </div>
    <div class="btnRow"><input accept=".wav,audio/wav,audio/wave" hidden="" id="fileInput" type="file"/><button class="btn" id="btnBrowse" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-folder" xlink:href="#ico-folder"></use></svg>ファイルを開く</button><span class="pill" id="statusPill">ファイル未選択</span><span class="pill fileName" id="fileName">-</span></div>
  </div>
  <div class="hdrMid"></div>
  <div class="hdrRight">
    <div class="btnRow"><button class="btn" id="btnChunk" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-puzzle" xlink:href="#ico-puzzle"></use></svg>チャンク/ログ</button><button class="btn" disabled="" id="btnCmcd" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-file-text" xlink:href="#ico-file-text"></use></svg>cmcd入力</button><button class="btn" id="btnPdfAttach" title="WAVへファイルを添付（LIST/adtl/file）"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-paperclip" xlink:href="#ico-paperclip"></use></svg>ファイル添付</button><button class="btn" disabled="" id="btnStdCheck" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-clipboard-check" xlink:href="#ico-clipboard-check"></use></svg>規格チェック</button><button class="btn good" disabled="" id="btnExport" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-download" xlink:href="#ico-download"></use></svg>書き出し</button></div>
    <span id="tierBadge" class="tierBadge--demo">DEMO</span>
        <div class="headerActions"><button aria-label="設定" class="btn" id="btnSettings" title="設定" type="button"><svg aria-hidden="true" class="btnIcon" focusable="false"><use href="#ico-gear" xlink:href="#ico-gear"></use></svg></button></div>
  </div>
</header>
<div id="licenseBanner" role="status" aria-live="polite"></div>
<dialog id="standardGraceDialog" class="standardGraceDialog" data-lock-close="1" aria-labelledby="standardGraceTitle" aria-describedby="standardGraceMessage">
  <div class="stdGraceBody">
    <div class="stdGraceTitle" id="standardGraceTitle">Standard認証のご案内</div>
    <div class="stdGraceMsg" id="standardGraceMessage">Standard認証が切れました。1時間後に書き出しのみ停止します。ネット接続を確認して再認証してください。</div>
  </div>
  <div class="stdGraceActions">
    <button class="btn primary" id="standardGraceOk" type="button">OK</button>
  </div>
</dialog>
<div class="main"><div class="left panel workCol"><div class="workTop"><div class="sectionHead"><div class="title"><b></b><span></span></div><div class="row"><span class="pill mono" id="timeHud">00:00.000</span><span class="pill mono" id="zoomHud">x1.00 / v1.00</span></div></div><div class="waveWrap"><div class="waveBox" id="waveBox"><canvas id="wave"></canvas><canvas id="cueCanvas"></canvas></div><div aria-label="transport" class="transport"><button class="tbtn" disabled="" id="btnPlay" type="button"><span class="ticon">▶︎</span> 再生</button><button class="tbtn" disabled="" id="btnPause" type="button"><span class="ticon ticonStop"></span> 停止</button><div class="tsep"></div><button class="tbtn" disabled="" id="btnZoomIn" type="button">＋ 横</button><button class="tbtn" disabled="" id="btnZoomOut" type="button">－ 横</button><div class="tsep"></div><button class="tbtn" disabled="" id="btnVZoomIn" type="button">＋ 縦</button><button class="tbtn" disabled="" id="btnVZoomOut" type="button">－ 縦</button><div class="thint mono">Space: 再生/停止　T/R: 横ズーム　Shift+T/R: 縦ズーム</div></div></div></div><div class="workBottom analyzers analyzersRow" id="analyzersRow"><div class="bottomRow"><div class="meterBox"><canvas id="meterCanvas"></canvas></div><div class="imagerBox"><canvas id="imagerCanvas"></canvas></div><div class="fileListBox"><div id="proFileDock" class="proFileDock">
  <div class="proFileDockTop">
    <div class="proFileDockLeft">
      <div class="proOnlyWrap" id="proBtnBulkImportWrap">
  <div class="proFileDockTop proFileDockRow">
    <div class="proOnlyWrap" id="proBtnBulkImportWrap">
      <span class="proBtnGroup">
        <button id="proBtnBulkImport" class="btn" type="button"><span class="btnLabel">一括読み込み</span></button>
        <span class="proBadge">PRO</span>
        <span class="proTooltip">Proで利用できます</span>
        <input accept=".wav,audio/wav,audio/wave" hidden="" id="proBulkInput" multiple="" type="file"/>
      </div>
      <div class="proOnlyWrap" id="proBtnBatchCheckWrap">
      </span>
      <span class="proTooltip">Proで利用できます</span>
      <input accept=".wav,audio/wav,audio/wave" hidden="" id="proBulkInput" multiple="" type="file"/>
    </div>
    <div class="proOnlyWrap" id="proBtnBatchCheckWrap">
      <span class="proBtnGroup">
        <button id="proBtnBatchCheck" class="btn" type="button"><span class="btnLabel">一括チェック</span></button>
        <span class="proBadge">PRO</span>
        <span class="proTooltip">Proで利用できます</span>
      </div>
      <div class="proOnlyWrap" id="proBtnBatchExportWrap">
      </span>
      <span class="proTooltip">Proで利用できます</span>
    </div>
    <div class="proOnlyWrap" id="proBtnBatchExportWrap">
      <span class="proBtnGroup">
        <button id="proBtnBatchExport" class="btn" type="button"><span class="btnLabel">まとめて書き出し</span></button>
        <span class="proBadge">PRO</span>
        <span class="proTooltip">Proで利用できます</span>
      </div>
      </span>
      <span class="proTooltip">Proで利用できます</span>
    </div>
    <div class="proFileDockRight">
      <div class="proFilterWrap">
        <select id="proFilterStatus" class="proSelect">
    <span class="proDockSpacer" aria-hidden="true"></span>
    <div class="proOnlyWrap proFilterWrap" id="proFilterWrap">
      <span class="proBtnGroup">
        <select id="proFilterStatus" class="btn proSelect proFilterSelect" disabled>
          <option value="all">全て</option>
          <option value="unverified">未確認</option>
          <option value="ok">規格OK</option>
          <option value="ng">規格NG</option>
          <option value="unexported">未書き出し</option>
          <option value="exported">書き出し済み</option>
        </select>
      </div>
      <div class="proOnlyWrap" id="proJobMiniWrap">
        <div id="proJobMini" class="proJobMini" title="履歴">
        <span class="proBadge">PRO</span>
      </span>
      <span class="proTooltip">Proで利用できます</span>
    </div>
    <div class="proOnlyWrap" id="proJobMiniWrap">
      <span class="proBtnGroup">
        <button id="proJobMini" class="btn proJobMini" type="button" title="履歴">
          <span id="proJobMiniText">履歴</span>
        </div>
        </button>
        <span class="proBadge">PRO</span>
        <span class="proTooltip">Proで利用できます</span>
      </div>
      </span>
      <span class="proTooltip">Proで利用できます</span>
    </div>
  </div>

  <div id="proFileListWrap" class="proFileListWrap">
        <div id="proFileList" class="proFileList" tabindex="0"></div>
  </div>

  <dialog id="proHistoryDialog" class="proHistoryDialog modal">
    <div class="modalHead">
      <div class="title">
        <b>履歴</b>
        <span class="muted" id="proHistorySubtitle">一括処理のログ</span>
      </div>
    </div>
    <div class="modalBody">
      <div class="proHistoryLayout">
        <div class="proHistoryList" id="proHistoryList"></div>
        <div id="proJobPanel" class="proJobPanel">
          <div class="proJobPanelHeader">
            <div class="proJobTitleRow">
              <div class="proJobTitle" id="proJobTitle">詳細ログ</div>
              <div id="proJobFailBadge" class="proJobBadge">—</div>
            </div>
            <div class="proJobHeaderBtns">
              <button id="proJobCopy" class="btnMini">コピー</button>
@@ -5133,50 +5531,51 @@ const updateTierBadge = (state)=>{
    const tierRaw = state && state.tier ? state.tier : "demo";
    const tier = String(tierRaw).toLowerCase();
    const label = tier === "pro" ? "PRO" : tier === "standard" ? "STANDARD" : "DEMO";
    badge.textContent = label;
    badge.classList.remove("tierBadge--demo", "tierBadge--standard", "tierBadge--pro");
    const cls = tier === "pro" ? "tierBadge--pro" : tier === "standard" ? "tierBadge--standard" : "tierBadge--demo";
    badge.classList.add(cls);
    if(tier !== _tierBadgeLast){
      console.log(`[TierBadge] tier=${tier}`);
      _tierBadgeLast = tier;
    }
  }catch(e){
    console.error("[License] non-fatal", e);
  }
};

const applyProUi = (state)=>{
  try{
    const tierRaw = state && state.tier ? state.tier : "demo";
    const tier = String(tierRaw).toLowerCase();
    const isPro = tier === "pro";
    const configs = [
      { wrapId: "proBtnBulkImportWrap", btnId: "proBtnBulkImport" },
      { wrapId: "proBtnBatchCheckWrap", btnId: "proBtnBatchCheck" },
      { wrapId: "proBtnBatchExportWrap", btnId: "proBtnBatchExport" },
      { wrapId: "proFilterWrap", btnId: "proFilterStatus" },
      { wrapId: "proJobMiniWrap", btnId: "proJobMini" },
    ];
    configs.forEach(({ wrapId, btnId })=>{
      const wrap = document.getElementById(wrapId);
      const btn = document.getElementById(btnId);
      if(btn && "disabled" in btn) btn.disabled = !isPro;
      if(wrap) wrap.classList.toggle("proOnlyDisabled", !isPro);
    });
    if(tier !== _proUiTierLast){
      console.log(`[ProUI] tier=${tier} bulkButtons=${isPro ? "enabled" : "disabled"}`);
      _proUiTierLast = tier;
    }
  }catch(e){
    console.error("[ProUI] non-fatal", e);
  }
};

let _demoStartupNoticeShown = false;
let _demoExportNoticeShown = false;
const buildDemoRemainingParts = (remainingDays, remainingExports)=>{
  const parts = [];
  if(Number.isFinite(remainingDays)){
    parts.push({ label: "日", value: remainingDays });
  }
  if(Number.isFinite(remainingExports)){
@@ -5374,50 +5773,78 @@ const applyLicenseUi = (state)=>{
    ].map(id=> document.getElementById(id));
    backupEls.forEach(el=> setDisabled(el, backupDisabled));
    document.querySelectorAll("[data-settings-folder]").forEach((el)=> setDisabled(el, backupDisabled));
    const demoNote = document.getElementById("settingsBackupDemoNote");
    if(demoNote) demoNote.style.display = backupDisabled ? "block" : "none";
  }catch(e){
    console.error("[License] non-fatal", e);
  }
  try{ updateDemoRemainingBanner(state); }catch(_){}
};

Promise.resolve(window.WavCueLicense?.getStateSafe?.()).then(updateTierBadge).catch((e)=>{
  console.error("[License] non-fatal", e);
});
Promise.resolve(window.WavCueLicense?.getStateSafe?.()).then(applyProUi).catch((e)=>{
  console.error("[ProUI] non-fatal", e);
});
Promise.resolve(window.WavCueLicense?.getStateSafe?.()).then(applyLicenseUi).catch((e)=>{
  console.error("[License] non-fatal", e);
});
if(typeof window.WavCueLicense?.onChange === "function"){
  window.WavCueLicense.onChange((st)=> updateTierBadge(st));
  window.WavCueLicense.onChange((st)=> applyProUi(st));
  window.WavCueLicense.onChange((st)=> applyLicenseUi(st));
}
(function(){
  const log = ()=>{
    const el = document.querySelector('.bottomRow') || document.querySelector('.proBottomRow');
    if(!el) return;
    const height = getComputedStyle(el)?.height;
    console.log("[UI][bottom] FINAL_OVERRIDES applied", height);
  };
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=> requestAnimationFrame(log), { once: true });
  }else{
    requestAnimationFrame(log);
  }
})();
(() => {
  let logged = false;
  const logDockSizes = () => {
    if(logged) return;
    const row = document.querySelector('.proFileDockRow') || document.querySelector('.proFileDockTop');
    const right = document.querySelector('.proFileDockRight');
    if(!row || !right) return;
    logged = true;
    console.log("[UI][dock] sizes", {
      rowHeight: row.clientHeight,
      rightWidth: right.clientWidth,
    });
  };
  window.addEventListener('resize', logDockSizes, { passive: true });
})();

const guardBulkImport = (ctx)=> LicenseCore.guard("bulkImport", ctx);
const guardBulkCheck = (ctx)=> LicenseCore.guard("bulkCheck", ctx);
const guardBulkExport = (ctx)=> LicenseCore.guard("bulkExport", ctx);
const guardExport = (ctx)=> LicenseCore.guard("exportSingle", ctx);
const guardHistory = (ctx)=> LicenseCore.guard("history", ctx);
const guardPreset = (ctx)=> LicenseCore.guard("preset", ctx);
const guardBackup = (ctx)=> LicenseCore.guard("backup", ctx);
window.guardBulkImport = guardBulkImport;
window.guardBulkCheck = guardBulkCheck;
window.guardBulkExport = guardBulkExport;
window.guardExport = guardExport;
window.guardHistory = guardHistory;
window.guardPreset = guardPreset;
window.guardBackup = guardBackup;
window._guardBulkImport = guardBulkImport;
window._guardBulkCheck = guardBulkCheck;
window._guardBulkExport = guardBulkExport;
window._guardExport = guardExport;
window._guardExportSingle = guardExport;
window._guardHistory = guardHistory;
window._guardPreset = guardPreset;
window._guardBackup = guardBackup;

(() => {
@@ -8695,96 +9122,116 @@ function rangeAvgDbfs(){
  if(!buf) return null;
  const st = state.cues.find(c=>c.label==="BC$STANDBY");
  const en = state.cues.find(c=>c.label==="BC$END");
  if(!st || !en) return null;
  const aS = Math.floor(Math.min(st.sec, en.sec) * buf.sampleRate);
  const bS = Math.floor(Math.max(st.sec, en.sec) * buf.sampleRate);
  if(bS<=aS) return null;
  const chL = buf.getChannelData(0);
  const chR = buf.numberOfChannels>1 ? buf.getChannelData(1) : chL;
  const n = bS-aS;
  const step = Math.max(1, Math.floor(n/250000));
  let sum=0,cnt=0;
  for(let i=aS;i<bS;i+=step){
    const L=chL[i], R=chR[i];
    sum += (L*L + R*R)*0.5;
    cnt++;
  }
  const rms = Math.sqrt(sum/Math.max(1,cnt));
  return dbfs(rms);
}
function drawMeter(a){
  const c = $("meterCanvas");
  const ctx = c.getContext("2d");
  const W = c.getBoundingClientRect().width;
  const H = c.getBoundingClientRect().height;
  const pad = 6;
  const labelW = 18;
  const gapX = 6;
  const footerH = 30;
  const topPad = 14;
  const baseY = H - footerH;
  const gridX = pad + labelW;
  const barX = gridX + gapX;
  const barAreaW = (W - pad) - barX;
  const laneGap = 6;
  const barW = Math.max(10, Math.floor((barAreaW - laneGap) / 2) - 2);
  const xL = barX;
  const xR = barX + barW + laneGap;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="rgba(0,0,0,.10)"; ctx.fillRect(0,0,W,H);

  const dbMin=-40, dbMax=0;
  const baseY = H-22;
  const toH = (db)=> clamp((db-dbMin)/(dbMax-dbMin),0,1)*(H-40);
  const toH = (db)=> clamp((db-dbMin)/(dbMax-dbMin),0,1)*(baseY - topPad);

  ctx.strokeStyle="rgba(148,163,184,.18)";
  ctx.lineWidth=1;
  ctx.font="9px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
  ctx.fillStyle="rgba(229,231,235,.55)";
  ctx.textBaseline = "middle";
  for(let t=0;t>=-40;t-=3){
    const y = baseY - toH(t);
    ctx.beginPath(); ctx.moveTo(8,y); ctx.lineTo(W-6,y); ctx.stroke();
    if(t%6===0 || t===0 || t===-40) ctx.fillText(String(t),2,y-2);
    ctx.beginPath(); ctx.moveTo(gridX,y); ctx.lineTo(W-pad,y); ctx.stroke();
    if(t%6===0 || t===0 || t===-40) ctx.fillText(String(t),pad,y);
  }

  const rmsLdb=dbfs(a.rmsL), rmsRdb=dbfs(a.rmsR);
  const pkLdb=dbfs(a.pkL), pkRdb=dbfs(a.pkR);

  const barW=Math.max(10, Math.floor((W-26)/2));
  const gap=6;
  const xL=12, xR=xL+barW+gap;
  const fitDbText = (v)=>{
    const full = `${v.toFixed(1)}dB`;
    if(ctx.measureText(full).width <= barW) return full;
    const mid = `${v.toFixed(0)}dB`;
    if(ctx.measureText(mid).width <= barW) return mid;
    return `${v.toFixed(0)}`;
  };

  const hL=toH(rmsLdb), hR=toH(rmsRdb);
  ctx.fillStyle="rgba(126,231,162,.55)";
  ctx.fillRect(xL, baseY-hL, barW, hL);
  ctx.fillRect(xR, baseY-hR, barW, hR);

  const yPkL=baseY-toH(pkLdb), yPkR=baseY-toH(pkRdb);
  ctx.strokeStyle="rgba(56,189,248,.95)";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(xL, yPkL); ctx.lineTo(xL+barW, yPkL);
  ctx.moveTo(xR, yPkR); ctx.lineTo(xR+barW, yPkR);
  ctx.stroke();

  ctx.fillStyle="rgba(229,231,235,.85)";
  ctx.font="11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
  ctx.fillText("L", xL, H-10);
  ctx.fillText("R", xR, H-10);
  ctx.font="10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
  const yLR = H - 16;
  const yDB = H - 4;
  ctx.textBaseline = "alphabetic";
  ctx.fillText("L", xL, yLR);
  ctx.fillText("R", xR, yLR);

  ctx.fillStyle="rgba(229,231,235,.70)";
  ctx.font="10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
  ctx.fillText(`${rmsLdb.toFixed(1)}dB`, xL, H-2);
  ctx.fillText(`${rmsRdb.toFixed(1)}dB`, xR, H-2);
  ctx.font="9px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
  ctx.fillText(fitDbText(rmsLdb), xL, yDB);
  ctx.fillText(fitDbText(rmsRdb), xR, yDB);
}

function drawImager(a){
  const c = $("imagerCanvas");
  const ctx = c.getContext("2d");
  const W = c.getBoundingClientRect().width;
  const H = c.getBoundingClientRect().height;

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="rgba(0,0,0,.10)";
  ctx.fillRect(0,0,W,H);

  // Axes: x = Side (L-R), y = Mid (L+R)
  ctx.strokeStyle="rgba(148,163,184,.18)";
  ctx.lineWidth=1;

  // Center (mono) line
  ctx.beginPath();
  ctx.moveTo(W/2, 8); ctx.lineTo(W/2, H-18);
  ctx.stroke();

  // Baseline
  ctx.beginPath();
  ctx.moveTo(8, H/2); ctx.lineTo(W-8, H/2);
  ctx.stroke();
@@ -18065,51 +18512,50 @@ try{
        const action = btn.getAttribute('data-action');
        openPopover(action, id, btn);
      });
    });

    if(project.popover.openType && project.popover.anchorEl && !document.body.contains(project.popover.anchorEl)){
      closePopover();
    }
  }
  function bind(){
    try{
      const dlg = document.getElementById("proHistoryDialog");
      if(dlg && dlg.parentElement !== document.body) document.body.appendChild(dlg);
      const pop = document.getElementById("proGlobalPopover");
      if(pop && pop.parentElement !== document.body) document.body.appendChild(pop);
      const toastRoot = document.getElementById("toastRoot");
      if(toastRoot && toastRoot.parentElement !== document.body) document.body.appendChild(toastRoot);
    }catch(_){}
    window.__wavcueProAddFiles = addFiles;

    $('proFilterStatus')?.addEventListener('change', (e)=>{
      project.filter.status = e.target.value||'all';
      render();
      console.log(`[Filter] set key=${project.filter.status} visible=${filtered().length}`);
    });

    $('proBtnBulkImport')?.addEventListener('click', ()=>{
      const gate = guardBulkImport({ source: "button" });
      if(!gate.ok){
        if(window.safeToast) window.safeToast(LICENSE_TEXT.bulkImportPro, "warn");
        return;
      }
      $('proBulkInput')?.click();
    });
    $('proBulkInput')?.addEventListener('change', async (e)=>{
      const files = e.target.files;
      if(!files || !files.length) return;
      const add = window.__wavcueProAddFiles;
      if(typeof add === "function"){
        await add(files);
      }else{
        await loadFile(files[0]);
      }
      e.target.value = "";
    });

    $('proBtnBatchCheck')?.addEventListener('click', ()=> {
      runJob('qc').catch((e)=> console.error("[BulkExport] runJob error", e));
    });
    $('proBtnBatchExport')?.addEventListener('click', ()=> {
      runJob('export').catch((e)=> console.error("[BulkExport] runJob error", e));
    });

    $('proJobMini')?.addEventListener('click', ()=>{
      const gate = guardHistory({ source: "history" });
      if(!gate.ok){
        if(window.safeToast) window.safeToast(LICENSE_TEXT.historyPro, "warn");
        return;
      }
      showJob(true);
    });
    $('proJobClose')?.addEventListener('click', ()=> showJob(false));
    if(!project.historyTriggerLogged){
      project.historyTriggerLogged = true;
      console.log("[UI] historyTrigger=rightOnly");
    }
    $('proJobCopy')?.addEventListener('click', async ()=>{
      try{
        const txt = $('proJobLog')?.innerText || "";
        await navigator.clipboard.writeText(txt);
        logJob("コピーしました", "muted");
      }catch(_){
        logJob("コピーに失敗しました（権限/環境）", "bad");
      }
    });
    $('proJobClear')?.addEventListener('click', ()=>{
      const entries = historyEntries();
      const entry = entries.find(e=>e.id===history.selectedId) || entries[0] || null;
      if(entry){
        entry.logLines = [];
      }
      logJob("クリアしました");
    });
    $('proJobCancel')?.addEventListener('click', ()=> { job.cancel=true; logJob('停止要求'); });
    $('proJobRetryFailed')?.addEventListener('click', ()=>{
      const entries = historyEntries();
      const entry = entries.find(e=>e.id===history.selectedId) || entries[0] || null;
      if(entry && entry.type === "qc" && Array.isArray(entry.failedIds) && entry.failedIds.length){
        runJob('qc', entry.failedIds.slice()).catch((e)=> console.error("[BulkExport] runJob error", e));
      }
    });

    document.addEventListener('click', (e)=>{
      const pop = $('proGlobalPopover');
      if(!pop || pop.classList.contains('hidden')) return;
      if(pop.contains(e.target)) return;
      closePopover();
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==="Escape") closePopover(); });
    window.addEventListener('resize', ()=>{ if(project.popover.openType) positionPopover(); });
    window.addEventListener('scroll', ()=>{ if(project.popover.openType) positionPopover(); }, {passive:true});
    $('proFileListWrap')?.addEventListener('scroll', ()=>{ if(project.popover.openType) positionPopover(); }, {passive:true});

    updateJobUI();
    render();
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>
<!-- ===== QC Preset Export Selector Overlay ===== -->

<dialog aria-label="cmcdプリセットエクスポート選択" class="scExportSelDialog" id="cmcdExportSelDialog">
<div class="box">
<div class="row" style="justify-content:flex-start">
<div style="font-weight:700">エクスポートするcmcdプリセットを選択</div>
</div>
<div class="row" style="margin-top:8px">
<button class="btn ghost" id="cmcd_es_all" style="border-radius:999px;padding:6px 10px" type="button">全選択</button>
<button class="btn ghost" id="cmcd_es_none" style="border-radius:999px;padding:6px 10px" type="button">全解除</button>
<div style="flex:1"></div>
<button class="btn" id="cmcd_es_export" style="border-radius:999px;padding:6px 12px" type="button">エクスポート</button>
</div>
<div class="list" id="cmcd_es_list"></div>
<div class="mutedSmall" style="margin-top:10px">
  選択したプリセットを書き出します。
</div>
</div>
</dialog>

<dialog aria-label="プリセットエクスポート選択" class="scExportSelDialog" id="scExportSelDialog">
<div class="box">
<div class="row" style="justify-content:flex-start">
<div style="font-weight:700">エクスポートするプリセットを選択</div>
</div>
<div class="row" style="margin-top:8px">
<button class="btn ghost" id="sc_es_all" style="border-radius:999px;padding:6px 10px" type="button">全選択</button>
<button class="btn ghost" id="sc_es_none" style="border-radius:999px;padding:6px 10px" type="button">全解除</button>
<div style="flex:1"></div>
<button class="btn" id="sc_es_export" style="border-radius:999px;padding:6px 12px" type="button">エクスポート</button>
</div>
<div class="list" id="sc_es_list"></div>
<div class="mutedSmall" style="margin-top:10px">
      選択したプリセットを書き出します。
    </div>
</div>
</dialog>
</div>

<!-- ===== CHANGELOG ===== -->
<dialog class="dlg" id="changelogDialog" style="max-width:min(760px, 96vw); width:min(760px,96vw);">
  <div class="dlgHead">
    <div class="dlgTitle">変更点</div>
    <button class="btn" id="btnChangelogClose" type="button">閉じる</button>
  </div>
  <div class="dlgBody" style="padding:14px 16px">
    <div class="muted" style="font-size:12px;line-height:1.55">
      この画面はプロトタイプ内の変更点メモです（機能説明ではありません）。
    </div>
    <ul id="changelogList" style="margin:12px 0 0 18px;line-height:1.7;font-size:12px;color:rgba(229,231,235,.88)">
      <li><b>v5_10_16</b>：添付一覧に #1〜#9 の番号バッジを常時表示。順序の説明文を追加。診断スナップショットに attachmentSlots(#番号+ファイル名) を自動添付。</li>
      <li><b>v5_10_14</b>：診断ログボタンをトップバーから撤去し、ログタブ内に「コピー/書き出し」を配置。書き出しテキストへ診断スナップショットを自動添付。</li>
      <li><b>v5_10_13</b>：安定性/診断/進捗バー強化（非対応WAVの早期検知、診断ログコピー、ロード/書き出しフェーズ固定、タイムアウト検知、添付Undo除外）</li>
      <li><b>v5_10_11</b>：44100Hz素材の書き出し後CUEズレ修正（fmt由来sampleRateでin-place patch）</li>
    </ul>
  </div>
</dialog>
<!-- ===== /CHANGELOG ===== -->

<div id="proGlobalPopover" class="proGlobalPopover hidden" role="dialog" aria-hidden="true">
  <div class="proGlobalPopoverInner">
    <div id="proPopTitle" class="proPopTitle"></div>
    <div id="proPopBody" class="proPopBody"></div>
  </div>
</div>
<div aria-atomic="true" aria-live="polite" class="toastHost" id="toastRoot"></div>
<dialog id="toastLayer" class="toastLayer" aria-live="polite" aria-atomic="true">
  <div class="toastHost" id="toastLayerHost"></div>
</dialog>

</body></html>
