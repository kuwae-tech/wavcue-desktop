<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WavCue Settings</title>
    <style>
      :root {
        --bg: #0b0c0f;
        --panel: #121417;
        --panel2: #171a1f;
        --line: #242a33;
        --text: #e9ecf1;
        --muted: #aab2bd;
        --accent: #ffd24a;
        --good: #7ee7a2;
        --shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
        --r: 16px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN",
          "Meiryo", sans-serif;
        background: radial-gradient(1200px 800px at 20% 10%, #15264a 0%, var(--bg) 55%);
        color: var(--text);
      }
      .app {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 20px;
      }
      .pageHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.3px;
      }
      h2 {
        margin: 0 0 8px;
        font-size: 14px;
        letter-spacing: 0.3px;
      }
      .subtitle {
        margin: 4px 0 0;
        font-size: 12px;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
      }
      .card {
        background: linear-gradient(180deg, rgba(23, 26, 31, 0.9), rgba(18, 20, 23, 0.9));
        border: 1px solid var(--line);
        border-radius: var(--r);
        padding: 14px;
        box-shadow: var(--shadow);
      }
      .muted {
        color: var(--muted);
      }
      .button-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
        transition: background 0.15s ease, transform 0.08s ease;
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.primary {
        border-color: rgba(126, 231, 162, 0.45);
        background: rgba(126, 231, 162, 0.12);
      }
      .btn.primary:hover {
        background: rgba(126, 231, 162, 0.18);
      }
      .paths {
        display: grid;
        gap: 8px;
        font-size: 12px;
      }
      .paths span {
        display: block;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(0, 0, 0, 0.2);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        color: rgba(229, 231, 235, 0.9);
      }
      .cleanup-result,
      .progress {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
      }
      .logCard {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .logHeader {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .log {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 12px;
        border: 1px solid var(--line);
        padding: 12px;
        min-height: 140px;
        max-height: 260px;
        overflow: auto;
        font-size: 12px;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        color: rgba(229, 231, 235, 0.9);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="pageHeader">
        <div>
          <h1>Settings</h1>
          <p class="subtitle">Storage / Paths / Cleanup</p>
        </div>
      </header>

      <div class="grid">
        <section class="card">
          <h2>Storage</h2>
          <p class="subtitle">Exports / Backups / Reports を開く</p>
          <div class="button-grid">
            <button class="btn" data-folder="exports">Exportsを開く</button>
            <button class="btn" data-folder="backups">Backupsを開く</button>
            <button class="btn" data-folder="reports">Reportsを開く</button>
          </div>
        </section>

        <section class="card">
          <h2>Paths</h2>
          <div class="paths" id="paths"></div>
        </section>

        <section class="card">
          <h2>Cleanup</h2>
          <button class="btn primary" id="cleanup-now">今すぐクリーンアップを実行</button>
          <div class="cleanup-result" id="cleanup-result">Last cleanup: not run yet.</div>
          <div class="progress" id="cleanup-progress">Idle.</div>
        </section>
      </div>

      <section class="card logCard">
        <div class="logHeader">
          <h2>Logs</h2>
          <span class="muted">Cleanup / Actions</span>
        </div>
        <div class="log" id="log">Ready.</div>
      </section>
    </div>

    <script>
      const log = (message) => {
        const logEl = document.getElementById('log');
        logEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}
${logEl.textContent}`;
      };

      const formatBytes = (bytes) => {
        if (!bytes) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let value = bytes;
        let unitIndex = 0;
        while (value >= 1024 && unitIndex < units.length - 1) {
          value /= 1024;
          unitIndex += 1;
        }
        return `${value.toFixed(1)} ${units[unitIndex]}`;
      };

      const updateCleanupResult = (result) => {
        const resultEl = document.getElementById('cleanup-result');
        if (!result || !result.timestamp) {
          resultEl.textContent = 'Last cleanup: not run yet.';
          return;
        }
        const when = new Date(result.timestamp).toLocaleString();
        resultEl.textContent = `Last cleanup (${when}): deleted ${result.deletedCount} jobs, freed ${formatBytes(
          result.deletedBytes,
        )}, errors ${result.errorCount}.`;
      };

      const updatePaths = async () => {
        const settings = await window.wavcue.getSettings();
        const paths = settings.paths || {};
        const container = document.getElementById('paths');
        container.innerHTML = [
          `Root: ${paths.root || 'Not set'}`,
          `Exports: ${paths.exports || 'Not set'}`,
          `Backups: ${paths.backups || 'Not set'}`,
          `Reports: ${paths.reports || 'Not set'}`,
        ]
          .map((line) => `<span>${line}</span>`)
          .join('');
        updateCleanupResult(settings.cleanupLastResult);
      };

      document.querySelectorAll('button[data-folder]').forEach((button) => {
        button.addEventListener('click', async () => {
          const kind = button.dataset.folder;
          const result = await window.wavcue.openFolder(kind);
          if (result.ok) {
            log(`Opened ${kind} folder.`);
          } else {
            log(`Failed to open ${kind} folder: ${result.message || 'unknown error'}`);
          }
        });
      });

      document.getElementById('cleanup-now').addEventListener('click', async () => {
        const progressEl = document.getElementById('cleanup-progress');
        progressEl.textContent = 'Starting cleanup...';
        log('Cleanup started.');
        const result = await window.wavcue.runCleanupNow();
        if (result.ok) {
          log(
            `Cleanup finished. Deleted ${result.summary.deletedCount} jobs, freed ${formatBytes(
              result.summary.deletedBytes,
            )}. Errors: ${result.summary.errorCount}.`,
          );
        } else {
          log(`Cleanup finished with errors. Errors: ${result.summary.errorCount}.`);
        }
        updateCleanupResult(result.summary);
      });

      window.wavcue.onCleanupProgress((payload) => {
        if (payload?.message) {
          document.getElementById('cleanup-progress').textContent = payload.message;
        }
      });

      window.wavcue.ensureDefaultFolders().then(() => {
        updatePaths();
      });
    </script>
  </body>
</html>
